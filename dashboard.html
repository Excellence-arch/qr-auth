<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>EventPass - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./assets/js/utilities.js"></script>
    <script src="./assets/js/main.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="./assets/css/style.css"
    />
    <style>
      .count-up {
        transition: all 1s ease-out;
      }

      .stats-card {
        transition: all 0.3s ease;
        transform: translateY(10px);
        opacity: 0;
      }

      .stats-card.animate {
        transform: translateY(0);
        opacity: 1;
      }

      .page-transition {
        transition: all 0.3s ease;
      }
      .hidden-page {
        opacity: 0;
        transform: translateY(20px);
        pointer-events: none;
        position: absolute;
        width: 100%;
      }
      .active-page {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .event-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .event-details.show {
        max-height: 500px;
        transition: max-height 0.5s ease-in;
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Water sliding animation */
      @keyframes waterSlideIn {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .water-slide {
        animation: waterSlideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      }

      /* Delay animations for staggered effect */
      .water-slide:nth-child(1) {
        animation-delay: 0.1s;
      }
      .water-slide:nth-child(2) {
        animation-delay: 0.2s;
      }
      .water-slide:nth-child(3) {
        animation-delay: 0.3s;
      }

      /* Wave loading animation */
      .wave-loading {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .wave-loading div {
        position: absolute;
        width: 16px;
        background: #3b82f6;
        animation: wave-loading 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
      }
      .wave-loading div:nth-child(1) {
        left: 8px;
        animation-delay: -0.24s;
      }
      .wave-loading div:nth-child(2) {
        left: 32px;
        animation-delay: -0.12s;
      }
      .wave-loading div:nth-child(3) {
        left: 56px;
        animation-delay: 0;
      }
      @keyframes wave-loading {
        0% {
          top: 8px;
          height: 64px;
        }
        50%,
        100% {
          top: 24px;
          height: 32px;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen font-sans">
    <!-- Dashboard Layout -->
    <!-- Dashboard Layout -->
    <div class="flex h-screen">
      <!-- Include sidebar -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <!-- <div class="flex-1 overflow-auto">
        Rest of your content
      </div>
    </div> -->

      <!-- Main Content -->
      <div class="flex-1 overflow-auto">
        <!-- Header -->
        <header
          class="bg-white shadow-sm p-4 flex justify-between items-center"
        >
          
          <h2 class="text-xl font-semibold text-gray-800">Dashboard</h2>
          <div class="flex space-x-3">
            <button
              id="add-event-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
            >
              <i class="fas fa-plus mr-1"></i> Add Event
            </button>
            <button
              id="add-attendee-btn"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
            >
              <i class="fas fa-user-plus mr-1"></i> Add Attendee
            </button>
          </div>
          <div id="add-event-modal-container"></div>
          <div id="add-attendee-modal-container"></div>
        </header>

        <!-- Dashboard Content -->
        <main class="p-6">
          <!-- Stats Cards -->
          <div
            class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"
            id="stats-cards"
          >
            <div
              class="bg-white rounded-xl shadow-sm p-6 card-hover stats-card"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">Total Events</p>
                  <h3
                    class="text-3xl font-bold text-gray-800"
                    id="total-events"
                  >
                    0
                  </h3>
                </div>
                <div class="bg-teal-100 p-3 rounded-full">
                  <i class="fas fa-calendar text-teal-600 text-xl"></i>
                </div>
              </div>
            </div>
            <div
              class="bg-white rounded-xl shadow-sm p-6 card-hover stats-card"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">Total Attendees</p>
                  <h3
                    class="text-3xl font-bold text-gray-800"
                    id="total-attendees"
                  >
                    0
                  </h3>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
              </div>
            </div>
            <div
              class="bg-white rounded-xl shadow-sm p-6 card-hover stats-card"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">Upcoming Events</p>
                  <h3
                    class="text-3xl font-bold text-gray-800"
                    id="upcoming-events"
                  >
                    0
                  </h3>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                  <i class="fas fa-clock text-purple-600 text-xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Events -->
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-gray-800">Recent Events</h3>
            </div>
            <div
              class="divide-y divide-gray-100"
              id="recent-events-container"
            >
              <div class="loading-spinner"></div>
            </div>
          </div>

          <!-- Recent Attendees -->
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div
              class="p-6 border-b border-gray-100 flex justify-between items-center"
            >
              <h3 class="text-lg font-semibold text-gray-800">
                Recent Attendees
              </h3>
              <a
                href="attendees.html"
                class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                >View All</a
              >
            </div>
            <div
              class="divide-y divide-gray-100"
              id="recent-attendees-container"
            >
              <div class="loading-spinner"></div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="./assets/js/sidebar.js"></script>

    <script>
      // Load modals
      fetch('add-event-modal.html')
        .then((response) => response.text())
        .then((data) => {
          document.getElementById('add-event-modal-container').innerHTML = data;
        });

      fetch('add-attendee-modal.html')
        .then((response) => response.text())
        .then((data) => {
          document.getElementById('add-attendee-modal-container').innerHTML =
            data;
        });
      // API base URL
      // const API_BASE_URL = 'http://localhost:5000/api/v1';

      // Load all data when DOM is loaded
      document.addEventListener('DOMContentLoaded', async function () {
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          window.location.href = 'index.html';
        }

        // Load all data
        await loadAllData();
      });

      // Load all data from API
      async function loadAllData() {
        try {
          // Show loading state
          document.getElementById('recent-events-container').innerHTML = `
        <div class="p-6 flex justify-center">
          <div class="wave-loading">
            <div></div><div></div><div></div>
          </div>
        </div>`;

          document.getElementById('recent-attendees-container').innerHTML = `
        <div class="p-6 flex justify-center">
          <div class="wave-loading">
            <div></div><div></div><div></div>
          </div>
        </div>`;

          // appState.user = await loadUserData();

          // Load user's events
          const eventsResponse = await fetch(`${API_BASE_URL}/event/account`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('authToken')}`,
            },
          });
          const eventsData = await eventsResponse.json();
          appState.events = eventsData.data.events;

          // Load analytics data
          const analyticsResponse = await fetch(
            `${API_BASE_URL}/auth/user/dashboard-analytics`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem('authToken')}`,
              },
            }
          );
          const analyticsData = await analyticsResponse.json();
          appState.analytics = analyticsData.data;

          // Update UI with loaded data
          updateDashboardStats();
          renderRecentEvents();
          renderRecentAttendees();
          populateEventDropdown();
        } catch (error) {
          console.error('Error loading data:', error);
          showToast('Failed to load data. Please try again.', 'error');
        }
      }

      // Populate event dropdown in add attendee modal
      function populateEventDropdown() {
        const select = document.getElementById('attendee-event');

        // Clear existing options except the first one
        while (select.options.length > 1) {
          select.remove(1);
        }

        // Add events from state
        appState.events.forEach((event) => {
          const option = document.createElement('option');
          option.value = event._id;
          option.textContent = event.name;
          select.appendChild(option);
        });
      }

      function showAddEventModal() {
        document.getElementById('add-event-modal').classList.remove('hidden');
      }

      function hideAddEventModal() {
        document.getElementById('add-event-modal').classList.add('hidden');
      }

      function showAddAttendeeModal() {
        document
          .getElementById('add-attendee-modal')
          .classList.remove('hidden');
      }

      function hideAddAttendeeModal() {
        document.getElementById('add-attendee-modal').classList.add('hidden');
      }
      document.addEventListener('DOMContentLoaded', function () {
        // Add Event button click handler
        document
          .getElementById('add-event-btn')
          ?.addEventListener('click', function () {
            const modal = document.getElementById('add-event-modal');
            if (modal) {
              showAddEventModal();
            }
          });

        

        // Add Attendee button click handler
        document
          .getElementById('add-attendee-btn')
          ?.addEventListener('click', function () {
            const modal = document.getElementById('add-attendee-modal');
            if (modal) {
              showAddAttendeeModal();
            }
          });
      });

      // Update dashboard statistics
      function updateDashboardStats() {
        // In the updateDashboardStats function, add this:
        if (appState.analytics.upcomingEvents?.length > 0) {
          const upcomingContainer = document.getElementById(
            'upcoming-events-container'
          );
          if (upcomingContainer) {
            upcomingContainer.innerHTML = appState.analytics.upcomingEvents
              .map(
                (event) => `
        <div class="p-4 border-b border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium">${event.name}</h4>
              <p class="text-sm text-gray-500">
                ${formatDate(event.startDate)} • ${event.location}
              </p>
            </div>
            <span class="${getStatusClass(event.status)}">
              ${getStatusText(event.status)}
            </span>
          </div>
        </div>
      `
              )
              .join('');
          }
        }

        // Animate stats cards
        const statsCards = document.querySelectorAll(
          '#stats-cards .stats-card'
        );
        statsCards.forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('animate');
          }, index * 150);
        });

        // Count-up animation for numbers
        animateValue(
          'total-events',
          0,
          appState.analytics.totalEvents || 0,
          1000
        );
        animateValue(
          'total-attendees',
          0,
          appState.analytics.totalAttendees || 0,
          1000
        );
        animateValue(
          'upcoming-events',
          0,
          appState.analytics.upcomingEvents?.length || 0,
          1000
        );
      }

      // Helper function for count-up animation
      function animateValue(id, start, end, duration) {
        const element = document.getElementById(id);
        if (!element) return;

        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          element.textContent = Math.floor(progress * (end - start) + start);
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
        });
      }

      function formatTime(timeString) {
        if (!timeString) return '';
        // Assuming timeString is in HH:MM format
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
      }

      function formatDateRange(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);

        if (start.toDateString() === end.toDateString()) {
          return formatDate(startDate);
        }

        if (
          start.getMonth() === end.getMonth() &&
          start.getFullYear() === end.getFullYear()
        ) {
          return `${start.getDate()} - ${formatDate(endDate)}`;
        }

        if (start.getFullYear() === end.getFullYear()) {
          return `${start.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
          })} - ${formatDate(endDate)}`;
        }

        return `${formatDate(startDate)} - ${formatDate(endDate)}`;
      }

      // Render recent events with real data
      function renderRecentEvents() {
        const container = document.getElementById('recent-events-container');

        if (
          !appState.analytics ||
          !appState.analytics.recentEvents ||
          appState.analytics.recentEvents.length === 0
        ) {
          container.innerHTML =
            '<div class="p-6 text-center text-gray-500">No recent events found</div>';
          return;
        }

        container.innerHTML = appState.analytics.recentEvents
          .map(
            (event, index) => `
            <div class="p-6 hover:bg-gray-50 transition cursor-pointer water-slide" style="opacity: 0; animation-delay: ${
              index * 0.1
            }s">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="font-medium text-gray-800">${event.name}</h4>
                  <p class="text-sm text-gray-500 mt-1">
                    ${formatDateRange(event.startDate, event.endDate)} • ${
              event.location
            }
                    ${event.startTime ? `• ${formatTime(event.startTime)}` : ''}
                    ${event.endTime ? `- ${formatTime(event.endTime)}` : ''}
                  </p>
                </div>
                <div class="flex items-center">
                  <span class="${getStatusClass(event.status)}">
                    ${getStatusText(event.status)}
                  </span>
                  <span class="ml-4 text-gray-800 font-medium">
                    ${event.attendeesCount} / ${event.capacity} attendees
                  </span>
                  <button onclick="toggleEventDetails(this)" class="ml-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                </div>
              </div>
              <div class="event-details mt-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                  <div>
                    <p class="text-sm text-gray-500">Description</p>
                    <p class="text-gray-800 mt-1">${event.description}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Details</p>
                    <p class="text-gray-800 mt-1">
                      <div>${formatDate(event.startDate)} ${
              event.startTime ? formatTime(event.startTime) : ''
            }</div>
                      <div>to ${formatDate(event.endDate)} ${
              event.endTime ? formatTime(event.endTime) : ''
            }</div>
                      <div>${event.location}</div>
                      ${
                        event.isPublic
                          ? '<div class="text-green-600">Public Event</div>'
                          : '<div class="text-blue-600">Private Event</div>'
                      }
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Attendance</p>
                    <p class="text-gray-800 mt-1">
                      <div>${event.attendeesCount} registered</div>
                      <div>${
                        event.capacity - event.attendeesCount
                      } spots remaining</div>
                      <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${
                          (event.attendeesCount / event.capacity) * 100
                        }%"></div>
                      </div>
                    </p>
                  </div>
                </div>
                <div class="flex justify-end mt-4 space-x-2">
                  <button class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-1.5 px-3 rounded-lg transition">
                    <i class="fas fa-edit mr-1"></i> Edit
                  </button>
                  <button class="text-sm bg-red-100 hover:bg-red-200 text-red-800 font-medium py-1.5 px-3 rounded-lg transition">
                    <i class="fas fa-trash mr-1"></i> Delete
                  </button>
                </div>
              </div>
            </div>
          `
          )
          .join('');
      }

      // Render recent attendees with real data
      function renderRecentAttendees() {
        const container = document.getElementById('recent-attendees-container');

        if (
          !appState.analytics ||
          !appState.analytics.recentAttendees ||
          appState.analytics.recentAttendees.length === 0
        ) {
          container.innerHTML =
            '<div class="p-6 text-center text-gray-500">No recent attendees found</div>';
          return;
        }

        container.innerHTML = appState.analytics.recentAttendees
          .map(
            (attendee, index) => `
      <div class="p-4 hover:bg-gray-50 transition water-slide" style="opacity: 0; animation-delay: ${
        index * 0.1
      }s">
        <div class="flex items-center">
          <div class="w-10 h-10 rounded-full ${getInitialsColor(
            index
          )} flex items-center justify-center text-white font-medium mr-4">
            ${getInitials(attendee.name)}
          </div>
          <div class="flex-1">
            <h4 class="font-medium text-gray-800">${attendee.name}</h4>
            <p class="text-sm text-gray-500">${attendee.email}</p>
          </div>
          <div class="text-sm text-gray-500">${attendee.eventName}</div>
          <div class="ml-4">
            <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800">
              Registered
            </span>
          </div>
        </div>
      </div>
    `
          )
          .join('');
      }

      // Populate event dropdown in add attendee modal
      function populateEventDropdown() {
        const select = document.getElementById('attendee-event');

        // Clear existing options except the first one
        while (select.options.length > 1) {
          select.remove(1);
        }

        // Add events from state
        appState.events.forEach((event) => {
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = event.name;
          select.appendChild(option);
        });
      }

      // Helper functions
      function formatDateRange(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);

        if (startDate === endDate) {
          return start.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric',
          });
        }

        if (
          start.getMonth() === end.getMonth() &&
          start.getFullYear() === end.getFullYear()
        ) {
          return `${start.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
          })}-${end.toLocaleDateString('en-US', {
            day: 'numeric',
            year: 'numeric',
          })}`;
        }

        if (start.getFullYear() === end.getFullYear()) {
          return `${start.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
          })} - ${end.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric',
          })}`;
        }

        return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
      }

      function getStatusClass(status) {
        const classes = {
          active: 'bg-blue-100 text-blue-800',
          completed: 'bg-green-100 text-green-800',
          upcoming: 'bg-yellow-100 text-yellow-800',
          cancelled: 'bg-red-100 text-red-800',
        };
        return `text-xs font-medium px-2.5 py-0.5 rounded-full ${
          classes[status] || 'bg-gray-100 text-gray-800'
        }`;
      }

      function getStatusText(status) {
        const texts = {
          active: 'Active',
          completed: 'Completed',
          upcoming: 'Upcoming',
          cancelled: 'Cancelled',
        };
        return texts[status] || status;
      }

      function getAttendeeStatusClass(status) {
        const classes = {
          'checked-in': 'bg-green-100 text-green-800',
          registered: 'bg-yellow-100 text-yellow-800',
          cancelled: 'bg-red-100 text-red-800',
          waiting: 'bg-gray-100 text-gray-800',
        };
        return `text-xs font-medium px-2.5 py-0.5 rounded-full ${
          classes[status] || 'bg-gray-100 text-gray-800'
        }`;
      }

      function getAttendeeStatusText(status) {
        const texts = {
          'checked-in': 'Checked In',
          registered: 'Registered',
          cancelled: 'Cancelled',
          waiting: 'Waiting List',
        };
        return texts[status] || status;
      }

      function getInitials(name) {
        return name
          .split(' ')
          .map((part) => part[0])
          .join('')
          .toUpperCase();
      }

      function getInitialsColor(id) {
        const colors = [
          'bg-teal-500',
          'bg-blue-500',
          'bg-purple-500',
          'bg-pink-500',
          'bg-red-500',
          'bg-orange-500',
          'bg-yellow-500',
          'bg-green-500',
          'bg-indigo-500',
        ];
        return colors[id % colors.length];
      }

      // Toggle event details
      function toggleEventDetails(button) {
        const eventItem = button.closest('.p-6');
        const details = eventItem.querySelector('.event-details');
        details.classList.toggle('show');

        const icon = button.querySelector('i');
        if (details.classList.contains('show')) {
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-up');
        } else {
          icon.classList.remove('fa-chevron-up');
          icon.classList.add('fa-chevron-down');
        }
      }
    </script>
    <!-- Toast Notifications Container -->
    <div
      id="toast-container"
      class="toast-container"
    ></div>
  </body>
</html>
